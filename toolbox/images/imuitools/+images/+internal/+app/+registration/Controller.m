classdef Controller<handle





    properties(Access=private)
model
view
    end

    methods
        function self=Controller(modelIn,viewIn)

            self.model=modelIn;
            self.view=viewIn;


            self.setupRegistrationTabListeners();
            self.setupDataBrowserListeners();
            self.setupParameterListeners();

        end

        function[]=setupRegistrationTabListeners(self)


            self.view.RegistrationTab.newSessionButton.ButtonPushedFcn=...
            @(hObj,evt)self.view.RegistrationTab.newSessionButtonCallback(self.view.DocumentArea.hRegisteredFig,imageslib.internal.app.utilities.ScreenUtilities.getToolCenter(self.view.App),self.view.App);
            addlistener(self.view.RegistrationTab.loadFromFilePopupItem,'ItemPushed',...
            @(hObj,evt)self.view.RegistrationTab.newSessionButtonCallback(self.view.DocumentArea.hRegisteredFig,imageslib.internal.app.utilities.ScreenUtilities.getToolCenter(self.view.App),self.view.App));
            addlistener(self.view.RegistrationTab.loadFromWorkspacePopupItem,'ItemPushed',...
            @(hObj,evt)self.view.RegistrationTab.loadImagesFromWorkspaceCallback(self.view.DocumentArea.hRegisteredFig,imageslib.internal.app.utilities.ScreenUtilities.getToolCenter(self.view.App)));
            addlistener(self.view.RegistrationTab,'loadedNewImages',...
            @(hObj,evtData)self.model.startSession('fixedImage',evtData.data.fixed,'movingImage',evtData.data.moving,...
            'fixedReferencingObject',evtData.data.fixedRefObj,'movingReferencingObject',evtData.data.movingRefObj,...
            'initialMovingTransform',evtData.data.movingTransform,'userLoadedTransform',evtData.data.userLoadedTransform,...
            'userLoadedFixedRefObj',evtData.data.userLoadedFixedRefObj,'userLoadedMovingRefObj',evtData.data.userLoadedMovingRefObj,...
            'isFixedRGB',evtData.data.isFixedRGB,'isMovingRGB',evtData.data.isMovingRGB,...
            'isFixedNormalized',evtData.data.isFixedNormalized,'isMovingNormalized',evtData.data.isMovingNormalized,...
            'movingRGBImage',evtData.data.movingRGBImage,'initialAlignments',evtData.data.initialArguments));
            addlistener(self.view.RegistrationTab,'loadedNewImages',...
            @(hObj,evtData)set(self.view.App,'Title',[images.internal.app.registration.ui.getMessageString('appName'),' - ',evtData.data.titleString]));
            addlistener(self.view.RegistrationTab,'loadedNewImages',...
            @(hObj,evtData)setImageSize(self.view,evtData.data.fixed,evtData.data.moving));
            addlistener(self.view.RegistrationTab,'loadedNewImages',...
            @(~,~)controlPanelSizeChange(self.view.DocumentArea));
            addlistener(self.view.RegistrationTab,'clearDataBrowser',...
            @(~,~)self.view.DocumentArea.hDataBrowser.deleteAllEntryCards());
            addlistener(self.model,'updatedFixedAndMovingImages',...
            @(hObj,evtData)self.view.DocumentArea.showImagePair(...
            self.view.RegistrationTab.comparisonButton.Value,...
            evtData.data.fixed,evtData.data.moving,...
            evtData.data.fixedRefObj,evtData.data.movingRefObj,evtData.data.featureData));
            addlistener(self.model,'updateScrollPanel',...
            @(hObj,evtData)self.view.DocumentArea.hScrollPanel.layoutScrollPanel(evtData.data.fixed,evtData.data.moving,...
            evtData.data.fixedRefObj,evtData.data.movingRefObj));

            addlistener(self.model,'errorThrown',...
            @(hObj,evtData)throwError(self.view,evtData.data.Message,evtData.data.Title));


            addlistener(self.model,'registrationStarted',...
            @(~,~)self.view.showAsBusy());
            addlistener(self.model,'registrationFinished',...
            @(~,~)self.view.unshowAsBusy());


            addlistener(self.view.RegistrationTab.galleryItems.SURF,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('SURF'));
            addlistener(self.view.RegistrationTab.galleryItems.FAST,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('FAST'));
            addlistener(self.view.RegistrationTab.galleryItems.BRISK,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('BRISK'));
            addlistener(self.view.RegistrationTab.galleryItems.Harris,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('Harris'));
            addlistener(self.view.RegistrationTab.galleryItems.MinEigen,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('MinEigen'));
            addlistener(self.view.RegistrationTab.galleryItems.MSER,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('MSER'));
            addlistener(self.view.RegistrationTab.galleryItems.KAZE,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('KAZE'));
            addlistener(self.view.RegistrationTab.galleryItems.ORB,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('ORB'));
            addlistener(self.view.RegistrationTab.galleryItems.Monomodal,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('Monomodal'));
            addlistener(self.view.RegistrationTab.galleryItems.Multimodal,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('Multimodal'));
            addlistener(self.view.RegistrationTab.galleryItems.xCorr,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('Phase Correlation'));
            addlistener(self.view.RegistrationTab.galleryItems.Nonrigid,'ItemPushed',...
            @(hObj,evt)self.model.addNewAlignment('Nonrigid'));


            addlistener(self.view.RegistrationTab,'runAlignment',...
            @(hObj,evt)self.model.runCurrentAlignment());


            addlistener(self.view.RegistrationTab.comparisonButton,'ValueChanged',...
            @(hObj,evt)self.model.setCurrentAlignment(self.view.DocumentArea.hDataBrowser.SelectedEntryID));


            self.view.RegistrationTab.exportButton.ButtonPushedFcn=...
            @(~,~)self.model.exportToWorkspace();
            addlistener(self.view.RegistrationTab.exportToWorkspace,'ItemPushed',...
            @(~,~)self.model.exportToWorkspace());
            addlistener(self.view.RegistrationTab.exportToFunction,'ItemPushed',...
            @(~,~)self.model.exportToFunction());
            addlistener(self.model,'alignmentExported',...
            @(hObj,evtData)self.view.RegistrationTab.exportToWorkspaceCallback(hObj,evtData,imageslib.internal.app.utilities.ScreenUtilities.getToolCenter(self.view.App)));
            addlistener(self.model,'alignmentFunctionGenerated',...
            @(hObj,evtData)self.view.RegistrationTab.exportToFunctionCallback(hObj,evtData,self.view.DocumentArea.hRegisteredFig));

        end

        function setupDataBrowserListeners(self)


            addlistener(self.model,'addEntryCard',...
            @(hObj,evtData)self.view.DocumentArea.hDataBrowser.createEntryCard(hObj,evtData));
            addlistener(self.model,'updateEntryCard',...
            @(hObj,evtData)self.view.DocumentArea.hDataBrowser.updateEntryCard(hObj,evtData));
            addlistener(self.model,'finalizeEntryCard',...
            @(hObj,evtData)self.view.DocumentArea.hDataBrowser.finalizeEntryCard(hObj,evtData));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserUpdated',...
            @(~,~)self.model.setCurrentAlignment(self.view.DocumentArea.hDataBrowser.SelectedEntryID));
            addlistener(self.view.DocumentArea.hDataBrowser,'DeleteSelectedEntry',...
            @(~,~)self.model.deleteCurrentAlignment(self.view.DocumentArea.hDataBrowser.SelectedEntryID));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserStatusChange',...
            @(~,~)self.view.RegistrationTab.enableRunButton(self.view.DocumentArea.hDataBrowser.SelectedEntryStatus));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserStatusChange',...
            @(~,~)self.view.RegistrationTab.enableExportButton(~self.view.DocumentArea.hDataBrowser.SelectedEntryDraft));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserStatusChange',...
            @(~,~)self.view.setStatusBar(self.view.DocumentArea.hDataBrowser.SelectedEntryMessage));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserStatusChange',...
            @(~,~)self.view.RegistrationTab.setRunTooltip(self.view.DocumentArea.hDataBrowser.SelectedEntryMessage));
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserCleared',...
            @(~,~)self.view.DocumentArea.clear);
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserCleared',...
            @(~,~)self.view.RegistrationTab.disableWhenEmpty);
            addlistener(self.view.DocumentArea.hDataBrowser,'DataBrowserCleared',...
            @(~,~)self.view.RegistrationTab.setRunTooltip(''));
            addlistener(self.model,'updatedSettingsPanel',...
            @(hObj,evtData)self.view.DocumentArea.updateSettingsPanel(hObj,evtData));

        end

        function setupParameterListeners(self)


            addlistener(self.view.DocumentArea,'addedChildAlignment',...
            @(hObj,evtData)self.model.addNewAlignment(evtData.data.modelName,evtData.data.modelNumber));
            addlistener(self.view.DocumentArea,'updatedCurrentAlignment',...
            @(hObj,evtData)self.model.updateAlignmentParameters(hObj,evtData));

        end

    end

end
