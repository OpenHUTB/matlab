function lCodeInstrRegistry=doStackInstrumentation(...
    lComponent,lModelName,lBuildInfo,compileBuildOptsInstr,...
    lMakeCommand,lBuildDirectory,lInstrSrcFolderFullPath,...
    foldersToInstrument,instrSrcFolder)






    coder.internal.copyCustomFilesToInstrument(lBuildInfo,lInstrSrcFolderFullPath,false);


    optGetFcn=@(x)get_param(lModelName,x);
    snifferDefaultOpts=coder.internal.getSnifferDefaultOpts(optGetFcn);
    lFrontEndOptions=coder.internal.doSnifferBuild(lBuildInfo,...
    compileBuildOptsInstr.isCpp,...
    compileBuildOptsInstr.sysTargetFile,...
    compileBuildOptsInstr.BuildMethod,...
    compileBuildOptsInstr.BuildVariant,...
    compileBuildOptsInstr.BuildConfiguration,...
    compileBuildOptsInstr.CustomToolchainOptions,...
    lMakeCommand,...
    compileBuildOptsInstr.BuildName,...
    snifferDefaultOpts,...
    'CompileErrorDiagnosticFunctions',compileBuildOptsInstr.CompileErrorDiagnosticFunctions,...
    'CoderTargetAuxMakeContent',compileBuildOptsInstr.CoderTargetAuxMakeContent);
    assert(~isempty(lFrontEndOptions));

    allSourceFileSpecs=coder.internal.CodeInstrBuildArgs.getCodeInstrSourceFileTypes;
    filesToInstrument=coder.internal.initializeInstrumentedSource...
    (instrSrcFolder,foldersToInstrument,...
    'FileSpecsToCopy',allSourceFileSpecs);



    coder.internal.updateBuildInfoWithInstrumentedFiles...
    (lBuildInfo,instrSrcFolder,foldersToInstrument,filesToInstrument);


    cfgTmp=Simulink.fileGenControl('getConfig');
    lAnchorFolder=cfgTmp.CodeGenFolder;
    lCodeFolderRelative=lBuildDirectory(length(lAnchorFolder)+2:end);
    lWordSize=get_param(lModelName,'TargetWordSize');
    lCodeInstrRegistry=coder.profile.StackProbeComponentRegistry(...
    lComponent,lComponent,lWordSize,get_param(lModelName,'MaxIdLength'),lCodeFolderRelative);

    assert(~isempty(lFrontEndOptions),'Front-End Options are not valid');
    lRemoveLineMarkers=false;
    lTreatErrorsAsWarnings=true;
    coder.internal.runEDGInstrumentation(lFrontEndOptions,lInstrSrcFolderFullPath,...
    {lCodeInstrRegistry},[],lWordSize,'',...
    lRemoveLineMarkers,lTreatErrorsAsWarnings);
end
