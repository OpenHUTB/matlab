



classdef FunctionInterfaceBuilder<handle
    properties(Access=private)
CodeInfoUtils
ModelInterfaceUtils
ConfigSetUtils
TimingInterfaceUtils
FunctionCallUtils
Writer

ModelInterface
CodeInfo
TunableParameters
    end


    methods(Access=public)
        function this=FunctionInterfaceBuilder(codeInfo,modelInterface,configSet,writer)
            this.CodeInfoUtils=coder.internal.modelreference.CodeInfoUtils(codeInfo);
            this.ModelInterfaceUtils=coder.internal.modelreference.ModelInterfaceUtils(modelInterface);
            this.ConfigSetUtils=coder.internal.modelreference.ConfigSetUtils(configSet);
            this.TimingInterfaceUtils=coder.internal.modelreference.TimingInterfaceUtils(this.CodeInfoUtils,this.ModelInterfaceUtils);
            this.FunctionCallUtils=coder.internal.modelreference.FunctionCallUtils(codeInfo,modelInterface);
            this.Writer=writer;
            this.CodeInfo=this.CodeInfoUtils.getCodeInfo;
            this.ModelInterface=this.ModelInterfaceUtils.getModelInterface;
            this.TunableParameters=coder.internal.modelreference.TunableParameters(this.CodeInfo,this.ModelInterfaceUtils);


            this.updateCodeInfoForSimTarget;
        end


        function writerObjs=getSimTargetWriterObjects(this)
            writerObjs={};


            writerObjs{end+1}=(coder.internal.modelreference.InstPWriter(this.ModelInterfaceUtils,this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlInitSystemMatricesWriter(this.ModelInterface,this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.UtilityFunctionsWriter(this.CodeInfo,this.ModelInterface,this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlProcessParametersWriter(...
            this.TunableParameters,this.ModelInterfaceUtils,this.CodeInfoUtils,this.Writer,this.CodeInfo.InitializeFunctions));


            functionInterfaces=this.FunctionCallUtils.getFunctionCallOutputFunctions;
            writerObjs{end+1}=(coder.internal.modelreference.FunctionCallInputWriter(...
            functionInterfaces,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            functionInterfaces=this.FunctionCallUtils.getFunctionCallEnableFunctions;
            writerObjs{end+1}=(coder.internal.modelreference.FunctionCallWriter(...
            functionInterfaces,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            functionInterfaces=this.FunctionCallUtils.getFunctionCallDisableFunctions;
            writerObjs{end+1}=(coder.internal.modelreference.FunctionCallWriter(...
            functionInterfaces,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.SimulinkFunctionsWriter(...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlSystemInitializeWriter(...
            this.CodeInfo.SystemInitializeFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlSystemResetWriter(...
            this.CodeInfo.SystemResetFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            if~isempty(this.CodeInfo.OutputFunctions)&&...
                (strcmp(this.CodeInfo.OutputFunctions(1).Timing.TimingMode,'PERIODIC')||...
                strcmp(this.CodeInfo.OutputFunctions(1).Timing.TimingMode,'APERIODIC'))
                writerObjs{end+1}=(coder.internal.modelreference.MdlPeriodicOutputUpdateWriter(...
                this.FunctionCallUtils.getOutputFunctions,...
                this.CodeInfo.UpdateFunctions,...
                this.ModelInterfaceUtils,...
                this.CodeInfoUtils,...
                this.Writer));
            end


            writerObjs{end+1}=(coder.internal.modelreference.MdlInitializeSizesWriter(...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.ConfigSetUtils,...
            this.TimingInterfaceUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlInitializeSampleTimesWriter(...
            this.CodeInfoUtils,...
            this.ModelInterfaceUtils,...
            this.TimingInterfaceUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlInitializeConditionsWriter(...
            this.CodeInfo.InitConditionsFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlSetWorkWidthsWriter(...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlSetupRuntimeResourcesWriter(...
            this.CodeInfo.SetupRuntimeResourcesFunction,...
            this.CodeInfo.InitializeFunctions,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.ConfigSetUtils,...
            this.Writer,...
            this.TunableParameters));


            writerObjs{end+1}=(coder.internal.modelreference.MdlStartWriter(...
            this.CodeInfo.InitializeFunctions,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.ConfigSetUtils,...
            this.Writer,...
            this.TunableParameters));


            functionInterface=this.FunctionCallUtils.getEnableFunction;
            writerObjs{end+1}=(coder.internal.modelreference.MdlEnableWriter(...
            functionInterface,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            functionInterface=this.FunctionCallUtils.getDisableFunction;
            writerObjs{end+1}=(coder.internal.modelreference.MdlDisableWriter(...
            functionInterface,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            functionInterfaces=this.FunctionCallUtils.getOutputFunctions;
            writerObjs{end+1}=(coder.internal.modelreference.MdlOutputsWriter(...
            functionInterfaces,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.TimingInterfaceUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlUpdateWriter(...
            this.CodeInfo.UpdateFunctions,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlZeroCrossingWriter(...
            this.CodeInfo.ZeroCrossingFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlDerivativeWriter(...
            this.CodeInfo.DerivativeFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlProjectionWriter(...
            this.CodeInfo.ProjectionFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlForcingFunctionWriter(...
            this.CodeInfo.ForcingFunctionFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlMassMatrixWriter(...
            this.CodeInfo.MassMatrixFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlTerminateWriter(...
            this.CodeInfo.TerminateFunctions,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlCleanupRuntimeResourcesWriter(...
            this.CodeInfo.CleanupRuntimeResourcesFunction,...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlGetSimStateWriter(...
            [],...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));


            writerObjs{end+1}=(coder.internal.modelreference.MdlSetSimStateWriter(...
            [],...
            this.ModelInterfaceUtils,...
            this.CodeInfoUtils,...
            this.Writer));
        end
    end


    methods(Access=private)
        function updateCodeInfoForSimTarget(this)
            this.updateOwner(this.CodeInfo.InternalData);
            this.updateOwner(this.CodeInfo.Inports);
            this.updateOwner(this.CodeInfo.Outports);
            this.updateOwner(this.CodeInfo.Parameters);
        end


        function updateOwner(this,dataInterfaces)
            numberOfDataInterface=length(dataInterfaces);
            for i=1:numberOfDataInterface
                implementation=dataInterfaces(i).Implementation;
                if~isempty(implementation)&&~implementation.isDefined
                    if class(implementation)=="RTW.PointerExpression"
                        implementation.TargetRegion.Owner=this.CodeInfo.Name;
                    else
                        implementation.Owner=this.CodeInfo.Name;
                    end
                end
            end
        end
    end
end
